#!/usr/bin/env bash
set -euxo pipefail

HOME=/home/ubuntu

mkdir -p "$HOME/code"
cd "$HOME/code"

if [[ ! -d "$HOME/.local/share/chezmoi" ]]; then
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply aneziac
else
  echo "dotfiles already cloned"
fi

cd "$HOME/.local/share/chezmoi/nix-config"

if ! command -v nix &> /dev/null; then
  echo "Installing nix..."
  sh <(curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install) --daemon

  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
else
  echo "Nix is already installed"
fi

nix run home-manager/master -- switch --flake .#mint
chezmoi apply
git remote set-url origin git@github.com:aneziac/dotfiles.git
